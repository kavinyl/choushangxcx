"use strict";var e=require("../../common/vendor.js");const t={components:{gashapon:()=>"../../components/gashapon/gashapon.js",imgview:()=>"../../components/preview/preview.js"},data:()=>({curProduct:{},line:{queue:!0,length:0},userList:[],proList:[],postcard:{amount:0,imgUrl:""},boxList:[],scrollTop:0,oldId:1,newId:1,msgAlert:"请先加入队列！",quantity:0,buyValue:1,payType:"wxPay",payComplete:!0,gashaponShow:!1,confirmPlay:!1,token:"",productCode:"",postcardCode:"",cdMinute:3,cdSecond:1,start:!1,productBoxCode:"",boxId:1,boxRemain:1,appid:"wx1fcd6e2e840c9e0c",secret:"",accessToken:"",openid:"",interval:"",firstTime:!0,userCurrency:0,startcd:!0,viewShow:!1,imgIndex:0,startTime:0,endTime:0,rules:{buyRule:!1,userRule:!1}}),onLoad(){},methods:{async test(){this.quantity=5,this.addSeconds(!0)},getJson(){e.index.request({url:"http://123.60.71.74:20001/mh/product/"+this.productCode,method:"GET",success:e=>{this.curProduct=e.data.data,this.getProductBox(),this.getUserCollect(),this.getUserPostcard()}})},getUserCollect(){e.index.request({url:"http://123.60.71.74:20001/mh/user/product/item/collect/info?productCode="+this.productCode,method:"GET",header:{token:this.token},success:e=>{this.userList=e.data.data,console.log("user",e)}})},getAmount(){var e=this;this.curProduct.leftAmount=0,this.curProduct.totalAmount=0,this.proList.forEach((function(t){e.curProduct.leftAmount+=t.leftAmount,e.curProduct.totalAmount+=t.totalAmount}))},getProductBox(){var t=this;e.index.request({url:"http://123.60.71.74:20001/mh/product/box/list/?productCode="+this.productCode,method:"GET",header:{token:this.token},success:o=>{if(this.boxList=o.data.data,e.index.getStorageSync("productBoxCode")){var s=e.index.getStorageSync("productBoxCode");t.boxList.forEach((function(e,o){s==e.productBoxCode&&(t.oldId=o+1)}))}this.checkBox(),this.boxRemain?(this.boxList[this.oldId-1].choose=!0,this.proList=this.boxList[this.oldId-1].productBoxItemVoList,console.log(this.proList),this.boxId=this.boxList[this.oldId-1].productBoxName,this.getAmount(),this.productBoxCode=this.boxList[this.oldId-1].productBoxCode,this.getQueueInfo()):t.line.length=-1}})},getUserPostcard(){var t=this;e.index.request({url:"http://123.60.71.74:20001/mh/user/postcard/list",method:"GET",header:{token:this.token},success:o=>{o.data.data.forEach((function(o){Number(o.postcardName)==Number(t.curProduct.price)&&(t.postcard.amount=o.amount,t.postcard.imgUrl=o.imgUrl,t.postcardCode=o.postcardCode,e.index.setStorage({key:"postcardCode",data:o.postcardCode}))}))}})},getUserCurrency(){return new Promise(((t,o)=>{e.index.request({url:"http://123.60.71.74:20001/mh/user/currency/info",method:"GET",header:{token:this.token},success:e=>{t(e.data.data.currencyAmount)},fail:e=>{o(e)}})}))},getQueueInfo(){e.index.request({url:"http://123.60.71.74:20001/mh/user/queue/info?productBoxCode="+this.productBoxCode,method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded",token:this.token},success:e=>{this.line.size=e.data.data.size,this.line.length=e.data.data.myPositionBeforeNum,this.line.myPosition=e.data.data.myPosition,0==this.line.length&&this.firstTime&&(this.updateFirst(0),this.firstTime=!1),0==this.line.length&&console.log("queue",this.line.length,"time",this.startTime,this.endTime)}})},queuingAdd(){this.line.queue=!1,this.setCountDown();const t=Date.now();e.index.request({url:"http://123.60.71.74:20001/mh/user/queue/add?productBoxCode="+this.productBoxCode,method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded",token:this.token},data:{addTime:t},success:t=>{this.getQueueInfo(),console.log("add",t),this.line.size=t.data.data.size,this.line.length=t.data.data.myPositionBeforeNum,this.line.myPosition=t.data.data.myPosition,this.subscribe(),e.index.setStorageSync("productBoxCode",this.productBoxCode)}})},queuingLeave(){this.line.queue=!0,e.index.request({url:"http://123.60.71.74:20001/mh/user/queue/leave?productBoxCode="+this.productBoxCode,method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded",token:this.token},success:t=>{console.log("leave",t),this.line.size=t.data.data.size,this.line.length=t.data.data.myPositionBeforeNum,this.line.myPosition=t.data.data.myPosition,e.index.removeStorageSync("isQueue"),e.index.removeStorageSync("productBoxCode"),this.firstTime=!0}})},requeue(){this.queuingLeave(),this.alertMessage("已过期，请重新排队！"),setTimeout((function(){e.index.redirectTo({url:"play"})}),1e3)},changeShow(){this.line.length<0&&(this.$refs.changebox.open("bottom"),this.getProductBox())},changeBox(e,t){var o=this;o.newId=t+1,o.oldId!==o.newId&&(e.choose=!0,o.boxList[o.oldId-1].choose=!1,o.proList=e.productBoxItemVoList),o.oldId=o.newId,this.getProductBox(),this.getAmount()},refresh(){this.getQueueInfo(),this.getProductBox(),console.log("刷新")},fav(){e.index.request({url:"http://123.60.71.74:20001//mh/user/favourite/add",method:"POST",header:{"Content-Type":"application/json",token:this.token},data:{productCode:this.productCode},success:t=>{console.log(t),e.index.showToast({title:"收藏成功！",icon:"none"})}})},alertMessage(e){var t=this;t.msgAlert=e,this.$refs.message.open("center"),setTimeout((function(){t.$refs.message.close()}),1e3)},buy(t){var o=this;e.index.getStorageSync("rules")?-1==o.line.length?o.alertMessage("请先加入队列！"):o.line.length>0?o.alertMessage("排队中，请稍候！"):0==o.line.length&&("number"==typeof t?o.quantity=t:"string"==typeof t&&(o.quantity=o.curProduct.leftAmount),o.postcard.amount>=o.quantity?o.order():o.cardLess()):this.showRule()},order(){this.$refs.order.open("center")},cardLess(){this.$refs.pcless.open("center")},buyPostcard(){var e=this;e.$refs.pcless.close(),e.$refs.buyCard.open("center"),e.buyValue=e.quantity-e.postcard.amount},newBuyPostcard(){this.$refs.buyCard.open("center"),this.buyValue=1},changeValue(e){this.buyValue=e},async orderPay(){var t=this;t.buyValue>0?"sxPay"==t.payType?(t.userCurrency=await t.getUserCurrency(),t.userCurrency>=t.curProduct.price*t.buyValue?(t.postcardAdd(),t.currencyMinus(),e.index.showToast({title:"购买成功！",icon:"none"}),setTimeout((function(){t.$refs.buyCard.close()}),1e3)):(e.index.showToast({title:"余额不足！",icon:"none"}),setTimeout((function(){e.index.navigateTo({url:"/pages/user/deposit"})}),1e3))):(this.wxPay(),t.checkWxPay()&&(t.postcardAdd(),e.index.showToast({title:"购买成功！",icon:"none"}),setTimeout((function(){t.$refs.buyCard.close()}),1e3))):0==t.buyValue?e.index.showToast({title:"购买数不能为0！",icon:"none"}):(t.$refs.buyCard.close(),t.alertMessage("购买失败，请重试！"))},checkWxPay:()=>!0,currencyMinus(){e.index.request({url:"http://123.60.71.74:20001/mh/user/currency/minus",method:"POST",header:{token:this.token,"Content-Type":"application/x-www-form-urlencoded"},data:{currencyAmount:this.curProduct.price*this.buyValue},success:e=>{console.log(e)}})},postcardAdd(){e.index.request({url:"http://123.60.71.74:20001/mh/user/postcard/add",method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded",token:this.token},data:{postcardCode:this.postcardCode,amount:this.buyValue},success:e=>{this.getUserPostcard()}})},postcardMinus(){e.index.request({url:"http://123.60.71.74:20001/mh/user/postcard/minus",method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded",token:this.token},data:{postcardCode:this.postcardCode,amount:this.quantity},success:e=>{this.getUserPostcard()}})},changePayType(e){this.payType=e+"Pay"},playReady(){this.gashaponShow=!0,this.$refs.order.close()},goAbout(){e.index.navigateTo({url:"/pages/about/about"})},closeMask(e){this.gashaponShow=e,this.confirmPlay=e},subscribe(){var t=this;e.index.requestSubscribeMessage({tmplIds:["G6mHGH66jrnVIKxKoTcGvkQ0M7yN52rNswef-KqyuNs","JEduhzoEoYLKZR5DG0MievdtCs042zSXslsuCfFUPM0"],success(e){t.noticeStart(),console.log("success")},fail:e=>{clog(e)}}),e.index.request({url:"http://123.60.71.74:20001/mh/open/wx/secret",method:"GET",success:e=>{this.secret=e.data.data,this.getAccessToken()}}),e.index.request({url:"http://123.60.71.74:20001/mh/open/wx/openId",method:"GET",header:{token:this.token},success:e=>{this.openid=e.data.data}})},getAccessToken(){e.index.request({url:"http://123.60.71.74:20001/mh/open/wx/access/token",method:"GET",success:e=>{this.accessToken=e.data.data}})},noticeStart(){var t=this;const o=new Date;var s=o.getFullYear()+"年"+o.getMonth()+"月"+o.getDate()+"日 "+o.getHours()+":"+o.getMinutes()+":"+o.getSeconds();const n={touser:t.openid,template_id:"G6mHGH66jrnVIKxKoTcGvkQ0M7yN52rNswef-KqyuNs",data:{thing6:{value:t.curProduct.productName},number7:{value:t.line.size},time8:{value:s}}};e.index.request({url:"https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token="+t.accessToken,method:"POST",data:JSON.stringify(n),success:e=>{}})},noticeSuccess(){var t=this;const o={touser:t.openid,template_id:"",data:{thing1:{value:t.curProduct.productName},character_string2:{value:t.line.myPositionBeforeNum},number3:{value:"5"},time4:{value:"2022-08-17 12:00:00"},thing5:{value:"备注信息"}}};e.index.request({url:"https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token="+t.accessToken,method:"POST",data:JSON.stringify(o),success:e=>{console.log(e)}})},setCountDown(){if(this.startcd=!1,this.startTime){const e=this.startTime+18e4-Date.now();this.cdMinute=Math.floor(e/1e3/60%60),this.cdSecond=Math.floor(e/1e3%60)}else this.cdMinute=3,this.cdSecond=0;this.$nextTick((()=>{this.startcd=!0}))},addSeconds(e){var t=this;if("5"==this.quantity&&e){let e=this.startTime+18e4-Date.now(),o=Math.floor(e/1e3/60%60),s=Math.floor(e/1e3%60);s>30&&2==o?(t.cdSecond=0,t.cdMinute=3,console.log(o,s)):(t.cdMinute=o,t.cdSecond=e.getSeconds()+30,console.log(o,s))}},checkBox(){var e=this;this.boxRemain=0,this.boxList.forEach((function(t){var o=0;t.productBoxItemVoList.forEach((function(e){o+=e.leftAmount})),0==o?t.isEmpty=!0:(t.isEmpty=!1,e.boxRemain++)}))},closeView(e){this.viewShow=e},imgPreview(e,t){this.imgIndex=t,this.viewShow=!0},updateFirst(t){if(0==t){let t=Date.now(),o=Date.now()+18e4;e.index.request({url:"http://123.60.71.74:20001/mh/user/queue/in/turn?productCode="+this.productCode,method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded",token:e.index.getStorageSync("token")},data:{startTime:t,endTime:o,productBoxCode:this.productBoxCode},success:t=>{e.index.getStorageSync("isQueue")||(console.log("updateFirst",t),e.index.setStorageSync("isQueue","true"))}}),this.getStartTime()}else{this.getStartTime();let o=this.startTime,s=this.endTime+3e4*t;e.index.request({url:"http://123.60.71.74:20001/mh/user/queue/in/turn?productCode="+this.productCode,method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded",token:e.index.getStorageSync("token")},data:{startTime:o,endTime:s},success:e=>{console.log("add30s",e)}})}},regularUpdate(){this.interval=setInterval((()=>{this.getQueueInfo(),console.log("update")}),1e4)},getStartTime(){if(this.productBoxCode=e.index.getStorageSync("productBoxCode"),!this.productBoxCode)return console.log("未加入队列"),void(this.firstTime=!0);this.firstTime=!1,e.index.request({url:"http://123.60.71.74:20001/mh/user/queue/in/turn/check?productBoxCode="+this.productBoxCode,method:"GET",header:{token:e.index.getStorageSync("token")},success:e=>{this.startTime=e.data.data.startTime,this.endTime=e.data.data.endTime}})},showRule(){this.$refs.rule.open("center")},agreeClick(e){switch(e){case 1:this.rules.buyRule=!this.rules.buyRule;break;case 2:this.rules.userRule=!this.rules.userRule}},agreeRules(){this.rules.buyRule&&this.rules.userRule?(e.index.setStorageSync("rules","ture"),this.$refs.rule.close()):e.index.showToast({title:"请阅读并打勾!",icon:"none"})},toPage(t){e.index.navigateTo({url:t})}},onShow(){clearInterval(this.interval),e.index.getStorageSync("userInfo")?this.token=e.index.getStorageSync("token"):(e.index.showToast({title:"请先登录",icon:"none"}),setTimeout((function(){e.index.switchTab({url:"../../pages/user"})}),1e3)),e.index.getStorage({key:"productCode",success:e=>{this.productCode=e.data,this.getJson()}}),this.getStartTime(),this.$nextTick((()=>{this.setCountDown()})),this.regularUpdate()},onUnload(){clearInterval(this.interval),console.log("stop")},mounted(){},watch:{confirmPlay:function(e){e&&this.postcardMinus()}}};if(!Array){(e.resolveComponent("uni-countdown")+e.resolveComponent("uni-popup")+e.resolveComponent("uni-popup-message")+e.resolveComponent("uni-number-box")+e.resolveComponent("gashapon")+e.resolveComponent("imgview"))()}Math||((()=>"../../uni_modules/uni-countdown/components/uni-countdown/uni-countdown.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup-message/uni-popup-message.js")+(()=>"../../uni_modules/uni-number-box/components/uni-number-box/uni-number-box.js")+(()=>"../../components/gashapon/gashapon.js"))();var o=e._export_sfc(t,[["render",function(t,o,s,n,i,a){return e.e({a:i.curProduct.imgUrl,b:e.t(i.curProduct.productName),c:100*this.curProduct.leftAmount/this.curProduct.totalAmount,d:e.t(i.curProduct.leftAmount),e:e.t(i.curProduct.totalAmount),f:e.t(i.boxRemain),g:e.t(i.boxId),h:e.o(((...e)=>a.changeShow&&a.changeShow(...e))),i:e.o(((...e)=>a.goAbout&&a.goAbout(...e))),j:-1==i.line.length},-1==i.line.length?{k:e.t(i.line.size)}:{},{l:i.line.length>0},i.line.length>0?{m:e.t(i.line.length)}:{},{n:0==i.line.length},0==i.line.length?e.e({o:i.startcd},i.startcd?{p:e.sr("ctd","644f827a-0"),q:e.o(a.requeue),r:e.p({"show-day":!1,hour:0,minute:i.cdMinute,second:i.cdSecond,fontSize:34,color:"#FE9703"})}:{}):{},{s:-1==i.line.length},-1==i.line.length?{t:e.o(((...e)=>a.queuingAdd&&a.queuingAdd(...e)))}:{},{v:i.line.length>=0},i.line.length>=0?{w:e.o(((...e)=>a.queuingLeave&&a.queuingLeave(...e)))}:{},{x:e.f(i.userList,((e,t,o)=>({a:e.imgUrl,b:!e.flagCollected,c:t}))),y:e.f(i.proList,((t,o,s)=>({a:t.imgUrl,b:e.o((e=>a.imgPreview(t,o))),c:0==t.leftAmount,d:e.t(t.itemTypeName),e:e.t(t.leftAmount),f:e.t(t.totalAmount),g:e.t(t.productItemName),h:o}))),z:e.t(i.postcard.amount),A:e.o((e=>a.newBuyPostcard())),B:e.o((e=>a.buy("all"))),C:e.o((e=>a.buy(5))),D:e.o((e=>a.buy(1))),E:e.o(((...e)=>a.fav&&a.fav(...e))),F:e.o(((...e)=>a.refresh&&a.refresh(...e))),G:e.f(i.boxList,((t,o,s)=>({a:e.t(t.productBoxName),b:t.choose,c:e.f(i.boxList[o].productBoxItemVoList,((t,o,s)=>({a:e.t(t.itemTypeName),b:e.t(t.leftAmount),c:e.t(t.totalAmount),d:100*t.leftAmount/t.totalAmount,e:o}))),d:t.isEmpty,e:e.o((e=>a.changeBox(t,o)),o),f:o}))),H:i.scrollTop,I:e.sr("changebox","644f827a-1"),J:e.p({type:"bottom"}),K:e.p({type:"info",message:i.msgAlert,duration:2e3}),L:e.sr("message","644f827a-2"),M:e.p({type:"message"}),N:e.o(((...e)=>a.goAbout&&a.goAbout(...e))),O:i.postcard.imgUrl,P:e.t(i.quantity),Q:e.t(i.postcard.amount),R:e.o(((...e)=>a.playReady&&a.playReady(...e))),S:e.sr("order","644f827a-4"),T:e.p({type:"center"}),U:e.o(((...e)=>a.buyPostcard&&a.buyPostcard(...e))),V:e.sr("pcless","644f827a-5"),W:e.p({type:"center"}),X:e.o(((...e)=>a.goAbout&&a.goAbout(...e))),Y:i.postcard.imgUrl,Z:e.o(a.changeValue),aa:e.o((e=>i.buyValue=e)),ab:e.p({max:99,modelValue:i.buyValue}),ac:e.t(i.curProduct.price*i.buyValue),ad:"wxPay"==i.payType,ae:e.o((e=>a.changePayType("wx"))),af:"sxPay"==i.payType,ag:e.o((e=>a.changePayType("sx"))),ah:e.o((e=>a.orderPay())),ai:e.sr("buyCard","644f827a-6"),aj:e.p({type:"center"}),ak:e.sr("gashapon","644f827a-8"),al:i.gashaponShow,am:e.o(a.closeMask),an:e.o(a.addSeconds),ao:e.p({quantity:i.quantity}),ap:i.rules.buyRule,aq:i.rules.buyRule?1:"",ar:e.o((e=>a.agreeClick(1))),as:e.o((e=>a.toPage("/pages/about/about"))),at:i.rules.userRule,av:i.rules.userRule?1:"",aw:e.o((e=>a.agreeClick(2))),ax:e.o((e=>a.toPage("/pages/about/agreements"))),ay:e.o(((...e)=>a.agreeRules&&a.agreeRules(...e))),az:e.sr("rule","644f827a-9"),aA:e.p({type:"center"}),aB:e.sr("preview","644f827a-10"),aC:i.viewShow,aD:e.o(a.closeView),aE:e.p({"pro-list":i.proList,index:i.imgIndex})})}]]);wx.createPage(o);
